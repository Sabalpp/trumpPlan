# Serverless Framework Configuration
# AWS Lambda deployment for Political Sentiment Alpha Platform

service: political-alpha-platform

provider:
  name: aws
  runtime: python3.10
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 512
  timeout: 300  # 5 minutes
  
  environment:
    FLASK_ENV: production
    DATABASE_URL: ${env:DATABASE_URL}
    REDIS_URL: ${env:REDIS_URL}
    X_API_BEARER_TOKEN: ${env:X_API_BEARER_TOKEN}
    ALPHA_VANTAGE_API_KEY: ${env:ALPHA_VANTAGE_API_KEY}
    AWS_S3_BUCKET: ${self:custom.bucketName}
    SECRET_KEY: ${env:SECRET_KEY}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:custom.bucketName}/*
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
          Resource:
            - !GetAtt TaskQueue.Arn
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: arn:aws:logs:*:*:*

custom:
  bucketName: political-alpha-data-${self:provider.stage}
  pythonRequirements:
    dockerizePip: true
    slim: true
    strip: false
    layer: true

functions:
  api:
    handler: lambda_handler.lambda_handler
    description: Main API handler (Flask routes via API Gateway)
    events:
      - http:
          path: /
          method: ANY
          cors: true
      - http:
          path: /{proxy+}
          method: ANY
          cors: true
    layers:
      - {Ref: PythonRequirementsLambdaLayer}
  
  ingestData:
    handler: lambda_handler.lambda_handler
    description: Periodic data ingestion from political sources
    events:
      - schedule:
          name: ingest-realtime-data
          description: Fetch real-time political data every minute
          rate: rate(1 minute)
          enabled: true
          input:
            source: aws.events
            detail-type: Scheduled Event - Data Ingestion
    layers:
      - {Ref: PythonRequirementsLambdaLayer}
  
  cleanupSignals:
    handler: lambda_handler.lambda_handler
    description: Cleanup expired trading signals
    events:
      - schedule:
          name: cleanup-expired-signals
          description: Mark old signals as expired
          rate: cron(0 0 * * ? *)  # Daily at midnight UTC
          enabled: true
          input:
            source: aws.events
            detail-type: Scheduled Event - Cleanup
    layers:
      - {Ref: PythonRequirementsLambdaLayer}
  
  dailySummary:
    handler: lambda_handler.lambda_handler
    description: Generate daily platform statistics
    events:
      - schedule:
          name: daily-summary
          description: Generate daily stats summary
          rate: cron(0 6 * * ? *)  # Daily at 6am UTC
          enabled: true
          input:
            source: aws.events
            detail-type: Scheduled Event - Summary
    layers:
      - {Ref: PythonRequirementsLambdaLayer}

resources:
  Resources:
    DataBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.bucketName}
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldData
              Status: Enabled
              ExpirationInDays: 90
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
    
    TaskQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: political-alpha-tasks-${self:provider.stage}
        VisibilityTimeout: 300
        MessageRetentionPeriod: 86400  # 1 day
        ReceiveMessageWaitTimeSeconds: 20
    
    ApiGatewayRestApi:
      Type: AWS::ApiGateway::RestApi
      Properties:
        Name: ${self:service}-${self:provider.stage}
        Description: Political Sentiment Alpha Platform API
    
    # CloudWatch Alarms
    HighErrorRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: ${self:service}-${self:provider.stage}-high-error-rate
        AlarmDescription: Alert when error rate exceeds 5%
        MetricName: Errors
        Namespace: AWS/Lambda
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 5
        ComparisonOperator: GreaterThanThreshold
        Dimensions:
          - Name: FunctionName
            Value: ${self:service}-${self:provider.stage}-api

plugins:
  - serverless-python-requirements
  - serverless-offline

package:
  exclude:
    - node_modules/**
    - venv/**
    - tests/**
    - .git/**
    - .vscode/**
    - __pycache__/**
    - "*.pyc"
    - .pytest_cache/**
    - docs/**
    - data/raw/**

